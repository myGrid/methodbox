<%= javascript_include_tag "sharing.js" -%>
<%= javascript_include_tag 'survey_checkbox.js' -%>
<%= stylesheet_link_tag 'survey_ul'%>
<%= stylesheet_link_tag 'faux_table'%>

<% if !@survey_hash.empty? %>
  <% if !Survey.all.empty? && !Dataset.all.empty? -%>
    <% @survey_search_query="Enter search terms" unless @survey_search_query -%>
    <% @survey_search_query= params[:survey_search_query] unless params[:survey_search_query]==nil -%>
    <div class="show_basic" style="padding-right: 2em;">
      <div id="survey_selector">
        <% form_tag(:action => "search_variables") do -%>
          <%= hidden_field_tag "page", 1 -%>
          <%= hidden_field_tag "per_page", 10 -%>
          <br/>
          <% if !logged_in? -%>
            <h2>Welcome, guest.  Please select some surveys and search for variables of interest to your research.  You can browse the metadata and see what is inside the MethodBox but only <%= link_to "registered users", signup_url -%> can add variables to their cart and download them.</h2><br/>
          <% else -%>
            <h2>Select some surveys, enter a search term and click the button to find some variables</h2><br/>
          <% end -%>
          <%= render :partial => "selection_bar" -%>
          <br/>
          <br/>
          <div id="currently_selected_datasets" style="display:none;">Currently selected datasets:</div>
          <div id="datasets_list"> 
            <%= render :partial => "dataset_list", :locals => { :survey_hash => @survey_hash } -%>
          </div>
          <% cache ["surveys_index_", current_user_or_none].join do -%>
            <div class="yui-skin-sam">
              <div id="surveys" class="yui-navset">
                <ul class="yui-nav">
                  <% tab_count = 1 %>
                  <% @survey_hash.each_key do |key| -%>
                    <% if tab_count == 1 %>
                      <li class="selected"><a href="#survey_tab_<%= tab_count.to_s -%>" title="<%= @survey_hash[key][0].survey_type.name == 'Health Survey for England' || @survey_hash[key][0].survey_type.name == 'General Household Survey' ? @survey_hash[key][0].survey_type.name + ' (MethodBox version - contains metadata from non nesstar source)' : @survey_hash[key][0].survey_type.name -%>"><em><%= h truncate(@survey_hash[key][0].survey_type.name == 'Health Survey for England' || @survey_hash[key][0].survey_type.name == 'General Household Survey' ? @survey_hash[key][0].survey_type.name + ' (MethodBox version)' : @survey_hash[key][0].survey_type.name, :length=> 70, :omission => '...') %></em></a></li>
                    <% else %>
                      <li><a href="#survey_tab_<%= tab_count.to_s -%>" title="<%= @survey_hash[key][0].survey_type.name == 'Health Survey for England' || @survey_hash[key][0].survey_type.name == 'General Household Survey' ? @survey_hash[key][0].survey_type.name + ' (MethodBox version - contains metadata from non nesstar source)' : @survey_hash[key][0].survey_type.name -%>"><em><%= h truncate(@survey_hash[key][0].survey_type.name == 'Health Survey for England' || @survey_hash[key][0].survey_type.name == 'General Household Survey' ? @survey_hash[key][0].survey_type.name + ' (MethodBox version)' : @survey_hash[key][0].survey_type.name, :length=> 70, :omission => '...') %></em></a></li>
                    <% end %>
	            <% tab_count += 1 %>
                  <% end %>
                </ul>            
                <div class="yui-content">
                  <% tab_id = 1 -%>
                  <% @survey_hash.each_key do |key| -%>
                    <div id="<%= 'survey_tab_' + tab_id.to_s -%>"><%= render :partial => "single_survey_check", :locals => { :tab_id => tab_id, :key => key, :collection => @survey_hash, :selected => Array.new, :authorization_for_showing_already_done=>true }  %></div>
	            <% tab_id += 1 -%>
                  <% end %>
                </div>
              </div>
            </div>
          <% end -%>
        <% end -%>
      </div>
    </div>
  <% else %>
    <% if logged_in? %>
      <% if Survey.all.empty? %>
        <h1>There are no surveys loaded into the methodbox at the moment.</h1>
          <p class="center"> Why not <%= link_to "upload a new survey", new_survey_path -%></p>
      <% else %>
        <h1>There are no surveys with datasets in the methodbox at the moment. </h1>
        <p class="center">Select a survey from the list and add a dataset to it.</p>
        <%= render :partial => "survey_list" -%>
      <% end -%>
    <% else %>
      <h1>There are no surveys loaded into the methodbox at the moment.</h1>
    <% end -%>
  <% end -%>
  <% if !@empty_surveys.empty? %>
    <h3>Surveys without any datasets</h3>
      <% @empty_surveys.each do |survey| %>
        <%= link_to survey.title, survey_url(survey) -%>
      <% end -%>
  <% end -%>
<% else %>
  <h1>There are no surveys available to view.</h1>
<% end %>
<script type="text/javascript">
  tabView = new YAHOO.widget.TabView("surveys");
   tabView.addListener("activeTabChange", handleTabViewActiveTabChange); 
   function handleTabViewActiveTabChange (e) {
      var newState;
      newState = this.getTabIndex(e.newValue);
      YAHOO.util.Cookie.set("surveys_tab", newState, {
        path: "/"
      });
   }
   var value = YAHOO.util.Cookie.get("surveys_tab");
   if (value != null) {
     tabView.set("activeIndex", value); 
   }
</script>
<script type="text/javascript">
  document.observe('dom:loaded', function() {
    uncheckAll();
  });
</script>
